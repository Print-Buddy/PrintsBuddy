<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1F2937;
            color: #F3F4F6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 p-6 bg-gray-800">
            <h1 class="text-2xl font-bold text-white">Admin Panel</h1>
            <nav class="mt-8">
                <a href="#" class="block px-4 py-2 text-lg text-gray-300 rounded-md hover:bg-gray-700">Dashboard</a>
                <a href="#" class="block px-4 py-2 mt-2 text-lg text-gray-300 rounded-md hover:bg-gray-700">Analytics</a>
                <a href="#" class="block px-4 py-2 mt-2 text-lg text-gray-300 rounded-md hover:bg-gray-700">Settings</a>
            </nav>
            <div class="mt-auto">
                <button id="logout-btn" class="w-full px-4 py-2 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-10">
            <h2 class="text-3xl font-bold">Welcome, Admin!</h2>
            <div class="mt-8">
                <div class="p-6 bg-gray-800 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold">Set Main Page Alert</h3>
                    <form id="alert-form" class="mt-4 space-y-4">
                        <div>
                            <label for="alert-message" class="block text-sm font-medium text-gray-300">Alert Message</label>
                            <input type="text" id="alert-message" name="alert-message" class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" id="set-alert-btn" class="px-4 py-2 font-semibold text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Set Alert</button>
                            <button type="button" id="clear-alert-btn" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Clear Alert</button>
                        </div>
                    </form>
                    <p id="alert-status" class="mt-4 text-green-500"></p>
                </div>
            </div>
            <div class="mt-8">
                <div class="p-6 bg-gray-800 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold">Manage Pricing</h3>
                    <form id="pricing-form" class="mt-4 space-y-6">
                        <!-- Pricing items will be dynamically generated here by JavaScript -->
                    </form>
                    <div class="flex space-x-4 mt-4">
                        <button type="button" id="save-pricing-btn" class="px-4 py-2 font-semibold text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Save Pricing</button>
                    </div>
                    <p id="pricing-status" class="mt-4 text-green-500"></p>
                </div>
            </div>
            <div class="mt-8">
                <div class="p-6 bg-gray-800 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold">Add New Poster to Wall of Buddy</h3>
                    <form id="poster-form" class="mt-4 space-y-4">
                        <div>
                            <label for="poster-title" class="block text-sm font-medium text-gray-300">Poster Title</label>
                            <input type="text" id="poster-title" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="poster-price" class="block text-sm font-medium text-gray-300">Price</label>
                            <input type="text" id="poster-price" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="poster-description" class="block text-sm font-medium text-gray-300">Description</label>
                            <input type="text" id="poster-description" required class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="poster-image" class="block text-sm font-medium text-gray-300">Image</label>
                            <input type="file" id="poster-image" accept="image/*" required class="w-full text-gray-300">
                        </div>
                        <button type="submit" id="upload-poster-btn" class="px-4 py-2 font-semibold text-white bg-cyan-600 rounded-md hover:bg-cyan-700">Upload Poster</button>
                    </form>
                    <p id="poster-status" class="mt-4 text-green-500"></p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getDatabase, ref, set, remove, onValue, push } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";
        import { firebaseConfig } from "./firebase-config.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Alert System
        const alertRef = ref(database, 'alert/message');
        const alertForm = document.getElementById('alert-form');
        const alertMessageInput = document.getElementById('alert-message');
        const alertStatus = document.getElementById('alert-status');

        alertForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = alertMessageInput.value;
            if (message) {
                set(alertRef, message)
                    .then(() => {
                        alertStatus.textContent = 'Alert set successfully!';
                        setTimeout(() => alertStatus.textContent = '', 3000);
                    })
                    .catch((error) => {
                        alertStatus.textContent = 'Error setting alert: ' + error.message;
                    });
            }
        });

        document.getElementById('clear-alert-btn').addEventListener('click', () => {
            remove(alertRef)
                .then(() => {
                    alertStatus.textContent = 'Alert cleared successfully!';
                    alertMessageInput.value = '';
                    setTimeout(() => alertStatus.textContent = '', 3000);
                })
                .catch((error) => {
                    alertStatus.textContent = 'Error clearing alert: ' + error.message;
                });
        });

        // --- Pricing Management ---
        const pricingRef = ref(database, 'pricing');
        const pricingForm = document.getElementById('pricing-form');
        const savePricingBtn = document.getElementById('save-pricing-btn');
        const pricingStatus = document.getElementById('pricing-status');

        let pricingData = {};

        const renderPricingForm = (data) => {
            pricingForm.innerHTML = '';
            const sortedData = Object.entries(data).sort(([, a], [, b]) => a.order - b.order);

            for (const [key, value] of sortedData) {
                const itemHtml = `
                    <div class="p-4 border border-gray-700 rounded-lg">
                        <h4 class="text-lg font-semibold text-cyan-400">${value.service}</h4>
                        <div class="mt-2">
                            <label for="price-${key}" class="block text-sm font-medium text-gray-300">Price</label>
                            <input type="text" id="price-${key}" data-key="${key}" data-field="price" value="${value.price}" class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md">
                        </div>
                        <div class="mt-2">
                            <label for="details-${key}" class="block text-sm font-medium text-gray-300">Details</label>
                            <input type="text" id="details-${key}" data-key="${key}" data-field="details" value="${value.details}" class="w-full px-3 py-2 mt-1 text-gray-900 bg-gray-300 rounded-md">
                        </div>
                    </div>
                `;
                pricingForm.insertAdjacentHTML('beforeend', itemHtml);
            }
        };

        onValue(pricingRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                pricingData = data;
                renderPricingForm(pricingData);
            } else {
                const initialPricingData = {
                    "bw-printing": { "service": "B&W Printing", "price": "₹4/page", "details": "High-quality black and white prints, A4 size", "order": 1 },
                    "color-printing": { "service": "Color Printing", "price": "₹15/page", "details": "Vibrant color prints, A4 size", "order": 2 },
                    "a4-posters": { "service": "A4 Posters", "price": "₹40/poster", "details": "Custom or pre-designed posters", "order": 3 },
                    "delivery-boys": { "service": "Campus Delivery (Boys)", "price": "Free", "details": "Delivery to all boys' hostels.", "order": 4 },
                    "delivery-girls": { "service": "Campus Delivery (Girls)", "price": "₹15/order", "details": "Delivery to all girls' hostels.", "order": 5 },
                    "bulk-discount": { "service": "Bulk Discount", "price": "10% off", "details": "For orders over 100 pages", "order": 6 }
                };
                set(pricingRef, initialPricingData);
            }
        }, { onlyOnce: true });

        savePricingBtn.addEventListener('click', () => {
            const inputs = pricingForm.querySelectorAll('input');
            let updatedPricingData = JSON.parse(JSON.stringify(pricingData));

            inputs.forEach(input => {
                const key = input.dataset.key;
                const field = input.dataset.field;
                updatedPricingData[key][field] = input.value;
            });

            set(pricingRef, updatedPricingData)
                .then(() => {
                    pricingStatus.textContent = 'Pricing updated successfully!';
                    setTimeout(() => pricingStatus.textContent = '', 3000);
                })
                .catch((error) => {
                    pricingStatus.textContent = 'Error updating pricing: ' + error.message;
                });
        });

        // --- Wall of Buddy Poster Upload ---
        const storage = getStorage(app);
        const postersRef = ref(database, 'posters');
        const posterForm = document.getElementById('poster-form');
        const posterStatus = document.getElementById('poster-status');

        posterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('poster-title').value;
            const price = document.getElementById('poster-price').value;
            const description = document.getElementById('poster-description').value;
            const imageFile = document.getElementById('poster-image').files[0];

            if (!imageFile) {
                posterStatus.textContent = 'Please select an image to upload.';
                return;
            }

            posterStatus.textContent = 'Uploading image...';
            const newPosterRef = storageRef(storage, `posters/${Date.now()}_${imageFile.name}`);

            uploadBytes(newPosterRef, imageFile)
                .then((snapshot) => getDownloadURL(snapshot.ref))
                .then((downloadURL) => {
                    posterStatus.textContent = 'Image uploaded. Saving data...';
                    const newPosterData = {
                        title: title,
                        price: price,
                        description: description,
                        image: downloadURL,
                        id: `poster-${Date.now()}` // Create a simple unique ID
                    };
                    return push(postersRef, newPosterData);
                })
                .then(() => {
                    posterStatus.textContent = 'New poster added successfully!';
                    posterForm.reset();
                    setTimeout(() => posterStatus.textContent = '', 3000);
                })
                .catch((error) => {
                    console.error(error);
                    posterStatus.textContent = 'Error: ' + error.message;
                });
        });


        const logoutBtn = document.getElementById('logout-btn');

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // User is not logged in, redirect to login page
                window.location.href = window.location.href.replace('dashboard.html', 'index.html');
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                // Sign-out successful.
                window.location.href = window.location.href.replace('dashboard.html', 'index.html');
            }).catch((error) => {
                // An error happened.
                console.error(error);
            });
        });
    </script>
</body>
</html>
